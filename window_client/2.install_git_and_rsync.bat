@echo off
setlocal

rem Git ?? ?? ?? (?? ?? ??: C:\Program Files\Git)
set GIT_PATH=C:\Program Files\Git\usr\bin

rem ??? ??? ???? URL ??
set OPENSSL_URL=https://repo.msys2.org/msys/x86_64/libopenssl-3.3.1-1-x86_64.pkg.tar.zst
set XXHASH_URL=https://repo.msys2.org/msys/x86_64/libxxhash-0.8.2-1-x86_64.pkg.tar.zst
set ZSTD_URL=https://repo.msys2.org/msys/x86_64/libzstd-1.5.6-1-x86_64.pkg.tar.zst

rem ?? ???? ??
set TEMP_DIR=%TEMP%\rsync_deps

rem ????? ?? ?? ??
set OPENSSL_FILE=%TEMP_DIR%\libopenssl.pkg.tar.zst
set XXHASH_FILE=%TEMP_DIR%\libxxhash.pkg.tar.zst
set ZSTD_FILE=%TEMP_DIR%\libzstd.pkg.tar.zst

rem ?? ??? ???? ??
set EXTRACT_DIR=%TEMP_DIR%\extract

rem rsync ??? ?? ?? (????? rsync ??? ?? ??)
set  =C:\Users\ccccc\OneDrive\?? ??\VSCode_src\backup_windows_data_to_linux_server\Private_backup_server\window_client\rsync-3.3.0-1-x86_64.pkg.tar.zst

rem ??? ??? ?? ???? ??
set RSYNC_EXTRACT_DIR=%TEMP%\rsync_extract

rem rsync.exe ??? ??? ?? ?? ??
set DEST_DIR="C:\Program Files\Git\usr\bin"

rem ?? ???? ??
if not exist %TEMP_DIR% mkdir %TEMP_DIR%
if not exist %EXTRACT_DIR% mkdir %EXTRACT_DIR%
if not exist %RSYNC_EXTRACT_DIR% mkdir %RSYNC_EXTRACT_DIR%

rem rem Git ?? ?? ??
rem if not exist %GIT_PATH%\bash.exe (
rem     echo Git is not installed. Please install Git before running this script.
rem     pause
rem     exit /b 1
rem )

rem ???? ? ?? ?? ??
:download_and_extract
    set URL=%1
    set FILE=%2
    set EXTRACT_PATH=%3
    echo Downloading %URL%...
    bitsadmin /transfer "DownloadDep" /priority high %URL% %FILE%
    if not exist %FILE% (
        echo Failed to download %URL%.
        pause
        exit /b 1
    )
    echo Extracting %FILE%...
    tar -I zstd -xf %FILE% -C %EXTRACT_PATH%
    if not exist %EXTRACT_PATH% (
        echo Failed to extract %FILE%.
        pause
        exit /b 1
    )
    goto :eof

rem ??? ??? ???? ? ?? ??
call :download_and_extract %OPENSSL_URL% %OPENSSL_FILE% %EXTRACT_DIR%
call :download_and_extract %XXHASH_URL% %XXHASH_FILE% %EXTRACT_DIR%
call :download_and_extract %ZSTD_URL% %ZSTD_FILE% %EXTRACT_DIR%

rem ??? ?? ??
echo Copying dependencies to %GIT_PATH%...
copy /y "%EXTRACT_DIR%\usr\bin\*.dll" %GIT_PATH%

rem rsync ??? ?? ?? ? rsync.exe ??
echo Extracting rsync package...
tar -I zstd -xf "%RSYNC_PACKAGE_PATH%" -C %RSYNC_EXTRACT_DIR%
if not exist "%RSYNC_EXTRACT_DIR%\usr\bin\rsync.exe" (
    echo Failed to extract rsync.exe.
    pause
    exit /b 1
)
copy /y "%RSYNC_EXTRACT_DIR%\usr\bin\rsync.exe" %DEST_DIR%

rem ?? ?? ??
echo Cleaning up temporary files...
rd /s /q %TEMP_DIR%
rd /s /q %RSYNC_EXTRACT_DIR%

echo rsync and dependencies have been successfully installed to %DEST_DIR%.
pause
endlocal




rem Git ?? ?? ??: C:\Program Files\Git\usr\bin? rsync ? ??? ??? ?????.

rem ??? ???? URL ??: ? ????? ??? ???? URL? ?????(libopenssl, libxxhash, libzstd).

rem ?? ???? ? ?? ?? ??: ??? ?????? ??? ??? ?? ??? ?? ??? ?????.

rem download_and_extract ??: ??? ???? ?????? tar ???? ??? ???? ??? ??? ?????. ? ??? ??? ??? ????? ?????? ??? ?????.

rem ??? ?? ??: ??? .dll ???? Git ??? ?????.

rem rsync.exe ?? ?? ?? ? ??: rsync ???? ?? ???? rsync.exe ??? Git ??? ?????.

rem ?? ?? ??: ??? ??? ?, ??? ??? ????? ???? ?????.